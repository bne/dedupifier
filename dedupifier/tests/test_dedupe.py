import os
import shutil
import unittest

from dedupifier import dedupe


RED_FILE = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00d\x00\x00\x00d\x08\x06\x00\x00\x00p\xe2\x95T\x00\x00\x00\x04sBIT\x08\x08\x08\x08|\x08d\x88\x00\x00\x01\x00IDATx\x9c\xed\xd1A\r\x00 \x10\xc0\xb0\x03\xff\x9e\xe1\x8d\x02\xf6h\x15,\xd9:3g\xc8\xd8\xbf\x03x\x19\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\xcc\x05\xecL\x02\xc6O\xb9\xb7?\x00\x00\x00\x00IEND\xaeB`\x82'
BLUE_FILE = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00d\x00\x00\x00d\x08\x06\x00\x00\x00p\xe2\x95T\x00\x00\x00\x04sBIT\x08\x08\x08\x08|\x08d\x88\x00\x00\x01\x01IDATx\x9c\xed\xd11\r\x00 \x00\xc00@\x0c\xfe\x1d\xc2\x8d\x02v\xb4\n\x96l\x8e}\xce c\xfd\x0e\xe0eH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x17+\xc2\x02\xec\x12\x9cRP\x00\x00\x00\x00IEND\xaeB`\x82'
YELLOW_FILE = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00d\x00\x00\x00d\x08\x06\x00\x00\x00p\xe2\x95T\x00\x00\x00\x04sBIT\x08\x08\x08\x08|\x08d\x88\x00\x00\x01\x01IDATx\x9c\xed\xd11\r\x00 \x00\xc00\xc0\xbf@\xdc\xc0\x8d\x02v\xb4\n\x96l\x9e=\xce c\xfd\x0e\xe0eH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x17\x1c\xc7\x03\x9e\x8a\xb8\xfb\xf8\x00\x00\x00\x00IEND\xaeB`\x82'
GREEN_FILE = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00d\x00\x00\x00d\x08\x06\x00\x00\x00p\xe2\x95T\x00\x00\x00\x04sBIT\x08\x08\x08\x08|\x08d\x88\x00\x00\x01\x01IDATx\x9c\xed\xd11\r\x00 \x00\xc00\xc0\t\xfeE\xc2\x8d\x02v\xb4\n\x96l\x8e\xb3\xcf c\xfd\x0e\xe0eH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x86\xc4\x18\x12cH\x8c!1\x17\x1dI\x02\xe7\x0f\x94\xb8q\x00\x00\x00\x00IEND\xaeB`\x82'


class DedupeTestCase(unittest.TestCase):

    root_path = os.path.join(os.path.dirname(__file__), 'data')
    structure = {
        'a': {
            'red.png': RED_FILE,
            'blue.png': BLUE_FILE,
        },
        'b': {
            'a': {
                'red.png': BLUE_FILE,
            },
            'b': {
                'blue.png': BLUE_FILE,
                'yellow.png': RED_FILE,
            },
            'yellow.png': YELLOW_FILE,
        },
        'c': {
            'a': {
                'yellow.png': GREEN_FILE,
                'blue.png': BLUE_FILE,
                'red.png': RED_FILE,
            },
            'b': {
                'a': {
                    'red.png': RED_FILE,
                }
            },
            'c': {
                'a': {
                    'yellow.png': RED_FILE,
                    'blue.png': GREEN_FILE
                },
                'b': {
                    'red.png': RED_FILE
                }
            }
        }
    }

    def setUp(self):
        self.tearDown()
        os.mkdir(self.root_path)
        current_path = [self.root_path]

        def _create_structure(structure):
            for item in structure:
                current_path.append(item)
                if isinstance(structure[item], dict):
                    os.mkdir(os.path.join(*current_path))
                    _create_structure(structure[item])
                elif isinstance(structure[item], bytes):
                    with open(os.path.join(*current_path), 'wb') as file:
                        file.write(structure[item])
                current_path.pop()

        _create_structure(self.structure)

        self.dedupifier = dedupe.Dedupifier(self.root_path)

    def tearDown(self):
        try:
            shutil.rmtree(self.root_path)
        except FileNotFoundError:
            pass

    def test_find_duplicates_by_name(self):
        self.dedupifier.use_hash = False
        self.dedupifier.get_items()

        self.assertEqual(len(self.dedupifier.items), 3)
        self.assertEqual(len(self.dedupifier.items['red.png']), 5)
        self.assertEqual(len(self.dedupifier.items['blue.png']), 4)
        self.assertEqual(len(self.dedupifier.items['yellow.png']), 4)

    def test_find_duplicates_by_hash(self):
        """
        4ad906ab212802e3399e47577cd11ea4 = green
        f44b218520c49516f4dbd66996e35dbb = blue
        caedc0f880459ab7f779e410d854ba3e = yellow
        f8d6a5a1048e120012f949ebba817205 = red
        """
        self.dedupifier.use_hash = True
        self.dedupifier.get_items()

        self.assertEqual(len(self.dedupifier.items), 4)
        self.assertEqual(len(self.dedupifier.items['4ad906ab212802e3399e47577cd11ea4']), 2)
        self.assertEqual(len(self.dedupifier.items['f44b218520c49516f4dbd66996e35dbb']), 4)
        self.assertEqual(len(self.dedupifier.items['caedc0f880459ab7f779e410d854ba3e']), 1)
        self.assertEqual(len(self.dedupifier.items['f8d6a5a1048e120012f949ebba817205']), 6)

